# è¿ç»­æ—¥è®°å¼è®°å¿†æ’ä»¶ - æ ¸å¿ƒè®¾è®¡

## ğŸ¯ æ ¸å¿ƒé€»è¾‘ï¼šä»¥é›¶ç‚¹ä¸ºç•Œçš„è‡ªç„¶å¤©

### æ—¶é—´åŸºå‡†
- **ä¸æ˜¯æ»šåŠ¨24å°æ—¶**ï¼Œè€Œæ˜¯ä»¥**æ¯å¤©é›¶ç‚¹ä¸ºç•Œ**
- **ä»Šå¤©** = ä»Šå¤©é›¶ç‚¹åˆ°ç°åœ¨
- **æ˜¨å¤©** = æ˜¨å¤©é›¶ç‚¹åˆ°æ˜¨å¤©23:59
- **å‰å¤©** = å‰å¤©é›¶ç‚¹åˆ°å‰å¤©23:59

### æ€»ç»“ç±»å‹

#### 1. ä»Šå¤©ï¼šå¢é‡æ€»ç»“
- **è§¦å‘**ï¼šæ»¡è¶³é…ç½®æ¡ä»¶ï¼ˆæ¶ˆæ¯æ•°/æ—¶é—´ï¼‰æ—¶è§¦å‘
- **æ¬¡æ•°**ï¼šä¸€å¤©å†…å¯èƒ½å¤šæ¬¡è§¦å‘
- **å†…å®¹**ï¼šä»é›¶ç‚¹åˆ°å½“å‰çš„æ‰€æœ‰æ¶ˆæ¯
- **å­˜å‚¨**ï¼šä¿å­˜åœ¨ `summaries["today"]` åˆ—è¡¨ä¸­

#### 2. æ˜¨å¤©ï¼šæ—¥ç»ˆæ€»ç»“
- **è§¦å‘**ï¼šè¿‡é›¶ç‚¹åç¬¬ä¸€æ¬¡add_messageæ—¶è‡ªåŠ¨è§¦å‘
- **æ¬¡æ•°**ï¼šä¸€å¤©åªè§¦å‘ä¸€æ¬¡ï¼ˆé›¶ç‚¹åé¦–æ¬¡ï¼‰
- **å†…å®¹**ï¼šæ•´åˆæ˜¨å¤©æ‰€æœ‰çš„å¢é‡æ€»ç»“ï¼ŒLLMé‡æ–°æ•´ç†ä¸ºå®Œæ•´æ—¥è®°
- **å­˜å‚¨**ï¼šå•ä¸ªå¯¹è±¡å­˜åœ¨ `summaries["yesterday"]`

#### 3. å‰å¤©ï¼šæ—¥ç»ˆæ€»ç»“
- **è§¦å‘**ï¼šåˆè¿‡é›¶ç‚¹æ—¶ï¼Œæ˜¨å¤©çš„æ€»ç»“è‡ªåŠ¨å½’æ¡£ä¸ºå‰å¤©
- **æ¬¡æ•°**ï¼šè‡ªåŠ¨å½’æ¡£ï¼Œä¸éœ€è¦LLMè°ƒç”¨
- **å†…å®¹**ï¼šå°±æ˜¯ä¹‹å‰çš„"æ˜¨å¤©"æ€»ç»“
- **å­˜å‚¨**ï¼šå•ä¸ªå¯¹è±¡å­˜åœ¨ `summaries["older"]`

## ğŸ“Š æ•°æ®ç»“æ„

```json
{
  "conversation_id": "group_123456",
  "pending_messages": [/* å¾…æ€»ç»“çš„æ¶ˆæ¯ */],
  "summaries": {
    "today": [
      {/* ä»Šå¤©çš„ç¬¬1æ¬¡å¢é‡æ€»ç»“ */},
      {/* ä»Šå¤©çš„ç¬¬2æ¬¡å¢é‡æ€»ç»“ */},
      {/* ... å¯èƒ½å¤šä¸ª */}
    ],
    "yesterday": {/* æ˜¨å¤©çš„å®Œæ•´æ—¥ç»ˆæ€»ç»“ï¼ˆå•ä¸ªï¼‰*/},
    "older": {/* å‰å¤©çš„å®Œæ•´æ—¥ç»ˆæ€»ç»“ï¼ˆå•ä¸ªï¼‰*/}
  },
  "last_summary_time": "2026-01-06T10:30:00",
  "last_summary_date": "2026-01-06",  // å…³é”®ï¼šç”¨äºæ£€æµ‹è·¨å¤©
  "metadata": {
    "identity": "æˆ‘æ˜¯éº¦éº¦...",  // ä¿å­˜äººè®¾ä¾›æ—¥ç»ˆæ€»ç»“ä½¿ç”¨
    "total_messages": 150,
    "total_summaries": 5
  }
}
```

## ğŸ”„ è·¨å¤©å¤„ç†æµç¨‹

```
æ¯æ¬¡ add_message() æ—¶ï¼š
  1. æ£€æŸ¥ last_summary_date æ˜¯å¦æ˜¯ä»Šå¤©
  
  2. å¦‚æœä¸æ˜¯ä»Šå¤©ï¼ˆè·¨å¤©äº†ï¼‰ï¼š
     a. older = yesterday  // æ˜¨å¤©çš„å½’æ¡£ä¸ºå‰å¤©
     b. æ•´åˆä»Šå¤©çš„æ‰€æœ‰å¢é‡ â†’ LLMè°ƒç”¨ â†’ yesterday
     c. today = []  // æ¸…ç©ºä»Šå¤©åˆ—è¡¨
     d. last_summary_date = ä»Šå¤©æ—¥æœŸ
  
  3. æ·»åŠ æ–°æ¶ˆæ¯åˆ° pending_messages
  
  4. æ£€æŸ¥æ˜¯å¦æ»¡è¶³ä»Šå¤©çš„å¢é‡æ€»ç»“æ¡ä»¶
     - ç¾¤èŠï¼šgroup_trigger_type + threshold
     - ç§èŠï¼šprivate_trigger_type + threshold
  
  5. å¦‚æœæ»¡è¶³ï¼šç”Ÿæˆå¢é‡æ€»ç»“ â†’ æ·»åŠ åˆ°todayåˆ—è¡¨
```

## âš™ï¸ é…ç½®é¡¹ï¼ˆæœ€ç»ˆç‰ˆï¼‰

```toml
[continuous_diary]
enable = true
enabled_chat_types = ["group", "private"]

# ç¾¤èŠè§¦å‘é…ç½®
group_trigger_type = "both"  # time | message | both
group_message_threshold = 50
group_time_interval_hours = 6

# ç§èŠè§¦å‘é…ç½®
private_trigger_type = "message"
private_message_threshold = 30
private_time_interval_hours = 12

# å­—æ•°é™åˆ¶ï¼ˆæ¨èæ¯”ä¾‹ 4:2:1ï¼‰
today_max_words = 2000      # ä»Šå¤©çš„å¢é‡æ€»ç»“æœ€å¤§å­—æ•°
yesterday_max_words = 1000  # æ˜¨å¤©çš„æ—¥ç»ˆæ€»ç»“æœ€å¤§å­—æ•°
older_max_words = 500       # å‰å¤©çš„æ—¥ç»ˆæ€»ç»“æœ€å¤§å­—æ•°

# å­˜å‚¨é…ç½®
retention_days = 3  # ä¿ç•™å¤©æ•°ï¼ˆä»Šå¤©+æ˜¨å¤©+å‰å¤©=3ï¼‰
```

## ğŸ’¾ å­˜å‚¨ä½ç½®

- **è·¯å¾„**ï¼š`{æ’ä»¶ç›®å½•}/data/{conversation_id}.json`
- **å®Œæ•´è·¯å¾„ç¤ºä¾‹**ï¼š`Bot/src/plugins/built_in/continuous_diary/data/group_123456.json`
- **ç‰¹ç‚¹**ï¼š
  - âœ… ç‹¬ç«‹äºä¸»ç¨‹åºæ•°æ®
  - âœ… ä¸å½±å“Botçš„å…¶ä»–åŠŸèƒ½
  - âœ… æ–¹ä¾¿å¤‡ä»½å’Œè¿ç§»

## ğŸ¨ Promptæ³¨å…¥

æ³¨å…¥åˆ°ä»¥ä¸‹promptç‚¹ï¼š
- `s4u_style_prompt`
- `kfc_main`
- `kfc_replyer`
- `kfc_unified_prompt`

æ³¨å…¥æ ¼å¼ï¼š
```
ã€ä»Šå¤©ã€‘
ä¸Šåˆ10ç‚¹å·¦å³ï¼Œå°æ˜é—®æˆ‘...ï¼ˆæœ€å¤š2000å­—ï¼‰

ã€æ˜¨å¤©ã€‘
æ˜¨å¤©æ—©ä¸Šå¤§å®¶è®¨è®ºäº†...ï¼ˆæœ€å¤š1000å­—ï¼‰

ã€å‰å¤©ã€‘
å‰å¤©èŠåˆ°äº†å‘¨æœ«è®¡åˆ’...ï¼ˆæœ€å¤š500å­—ï¼‰
```

## ğŸ“ LLMè°ƒç”¨

### 1. å¢é‡æ€»ç»“ï¼ˆä»Šå¤©ï¼‰
- **è°ƒç”¨æ—¶æœº**ï¼šæ»¡è¶³è§¦å‘æ¡ä»¶æ—¶
- **è¾“å…¥**ï¼špending_messages
- **è¾“å‡º**ï¼šå¢é‡æ—¥è®°ï¼ˆçº¦2000å­—ï¼‰
- **Prompt**ï¼šæµæ°´è´¦å¼è®°å½•ï¼Œå¸¦äººè®¾ï¼Œç¬¬ä¸€äººç§°

### 2. æ—¥ç»ˆæ€»ç»“ï¼ˆæ˜¨å¤©/å‰å¤©ï¼‰
- **è°ƒç”¨æ—¶æœº**ï¼šè·¨é›¶ç‚¹æ—¶
- **è¾“å…¥**ï¼šä»Šå¤©æ‰€æœ‰å¢é‡æ€»ç»“çš„æ‹¼æ¥
- **è¾“å‡º**ï¼šå®Œæ•´çš„ä¸€å¤©æ—¥è®°ï¼ˆçº¦1000/500å­—ï¼‰
- **Prompt**ï¼šæ•´åˆé‡ç»„ï¼Œçªå‡ºé‡ç‚¹ï¼Œç²¾ç®€å™è¿°

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

- **å¹¶å‘å®‰å…¨**ï¼šasyncio.Lock æŒ‰ conversation_id åŠ é”
- **è‡ªåŠ¨æ¸…ç†**ï¼šè·¨å¤©æ—¶è‡ªåŠ¨åˆ é™¤è¶…æœŸæ•°æ®
- **æ‡’åŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶è¯»å–jsonæ–‡ä»¶
- **æˆæœ¬æ§åˆ¶**ï¼šç”¨æˆ·å¯è‡ªç”±è°ƒæ•´å­—æ•°é™åˆ¶

## ğŸ”§ ä½¿ç”¨å»ºè®®

### é«˜é¢‘ç¾¤èŠ
```toml
group_trigger_type = "both"  # ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ‰è§¦å‘
group_message_threshold = 100
group_time_interval_hours = 12
today_max_words = 3000
```

### ä½é¢‘ç§èŠ
```toml
private_trigger_type = "message"  # åªæŒ‰æ¶ˆæ¯æ•°
private_message_threshold = 20
today_max_words = 1500
```

### æˆæœ¬æ•æ„Ÿ
```toml
today_max_words = 1000
yesterday_max_words = 500
older_max_words = 200
```

### è´¨é‡ä¼˜å…ˆ
```toml
today_max_words = 4000
yesterday_max_words = 2000
older_max_words = 1000
```
